
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.3">
    
    
      
        <title>GMP scraping Custom App metrics - GMP Hack Days</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e35208c4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#scraping-metrics-app-metrics-with-gmp-and-managed-collections" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="GMP Hack Days" class="md-header__button md-logo" aria-label="GMP Hack Days" data-md-component="logo">
      
  <img src="../images/prometheus.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            GMP Hack Days
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              GMP scraping Custom App metrics
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="GMP Hack Days" class="md-nav__button md-logo" aria-label="GMP Hack Days" data-md-component="logo">
      
  <img src="../images/prometheus.png" alt="logo">

    </a>
    GMP Hack Days
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        Self-deployed collection
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Self-deployed collection" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Self-deployed collection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../prometheus-operator-to-gmp/" class="md-nav__link">
        Prometheus-operator scraping metrics to GMP
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      <label class="md-nav__link" for="__nav_3">
        Managed collection with GKE Standard
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Managed collection with GKE Standard" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Managed collection with GKE Standard
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          GMP scraping Custom App metrics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        GMP scraping Custom App metrics
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-configure-gmp-and-managed-collections" class="md-nav__link">
    1 Configure GMP and Managed Collections
  </a>
  
    <nav class="md-nav" aria-label="1 Configure GMP and Managed Collections">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-create-regional-gke-cluster-on-gcp-with-gmp" class="md-nav__link">
    1.1 Create Regional GKE Cluster on GCP with GMP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-deploy-prom-example-application-and-scrape-custom-metrics-with-podmonitoring" class="md-nav__link">
    1.2 Deploy prom-example application and scrape custom metrics with PodMonitoring
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-configure-prometheus-ui-and-grafana-dashboards" class="md-nav__link">
    2 Configure Prometheus UI and Grafana Dashboards
  </a>
  
    <nav class="md-nav" aria-label="2 Configure Prometheus UI and Grafana Dashboards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-verify-sa-account-has-correct-permissions" class="md-nav__link">
    2.1 Verify SA account has correct permissions.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-setup-prometheus-ui-for-gmp" class="md-nav__link">
    2.2 Setup Prometheus UI for GMP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-use-grafana-with-gmp" class="md-nav__link">
    2.3 Use Grafana with GMP
  </a>
  
    <nav class="md-nav" aria-label="2.3 Use Grafana with GMP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#231-install-grafana" class="md-nav__link">
    2.3.1 Install Grafana
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#232-configure-grafana-to-work-with-gmp" class="md-nav__link">
    2.3.2 Configure Grafana to work with GMP
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-verify-gmp-cost" class="md-nav__link">
    3 Verify GMP Cost
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-cleanup" class="md-nav__link">
    4 Cleanup
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../gmp-with-gkestandard-flientbit/" class="md-nav__link">
        GMP scraping Fluent-bit metrics (WIP)
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../gmp-with-gkestandard-nginxingress/" class="md-nav__link">
        GMP scraping Nginx-Ingress metrics (WIP)
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../gmp-for-gcp-cloud-resources/" class="md-nav__link">
        GMP quering Google Cloud Metrics with PromQL and Grafana (WIP)
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../gmp-multi-tenant/" class="md-nav__link">
        Centralized Multi-tenant GMP setup with GKE Clusters in Different Projects (WIP)
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        Setting up GMP with KCC
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Setting up GMP with KCC" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Setting up GMP with KCC
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../gmp-with-kcc/" class="md-nav__link">
        Automate GMP deployument with KCC
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-configure-gmp-and-managed-collections" class="md-nav__link">
    1 Configure GMP and Managed Collections
  </a>
  
    <nav class="md-nav" aria-label="1 Configure GMP and Managed Collections">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-create-regional-gke-cluster-on-gcp-with-gmp" class="md-nav__link">
    1.1 Create Regional GKE Cluster on GCP with GMP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-deploy-prom-example-application-and-scrape-custom-metrics-with-podmonitoring" class="md-nav__link">
    1.2 Deploy prom-example application and scrape custom metrics with PodMonitoring
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-configure-prometheus-ui-and-grafana-dashboards" class="md-nav__link">
    2 Configure Prometheus UI and Grafana Dashboards
  </a>
  
    <nav class="md-nav" aria-label="2 Configure Prometheus UI and Grafana Dashboards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-verify-sa-account-has-correct-permissions" class="md-nav__link">
    2.1 Verify SA account has correct permissions.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-setup-prometheus-ui-for-gmp" class="md-nav__link">
    2.2 Setup Prometheus UI for GMP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-use-grafana-with-gmp" class="md-nav__link">
    2.3 Use Grafana with GMP
  </a>
  
    <nav class="md-nav" aria-label="2.3 Use Grafana with GMP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#231-install-grafana" class="md-nav__link">
    2.3.1 Install Grafana
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#232-configure-grafana-to-work-with-gmp" class="md-nav__link">
    2.3.2 Configure Grafana to work with GMP
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-verify-gmp-cost" class="md-nav__link">
    3 Verify GMP Cost
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-cleanup" class="md-nav__link">
    4 Cleanup
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="scraping-metrics-app-metrics-with-gmp-and-managed-collections">Scraping Metrics App metrics with GMP and Managed Collections<a class="headerlink" href="#scraping-metrics-app-metrics-with-gmp-and-managed-collections" title="Permanent link">&para;</a></h1>
<h2 id="1-configure-gmp-and-managed-collections">1 Configure GMP and Managed Collections<a class="headerlink" href="#1-configure-gmp-and-managed-collections" title="Permanent link">&para;</a></h2>
<h3 id="11-create-regional-gke-cluster-on-gcp-with-gmp">1.1 Create Regional GKE Cluster on GCP with GMP<a class="headerlink" href="#11-create-regional-gke-cluster-on-gcp-with-gmp" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong> Enable the Google Kubernetes Engine API.</p>
<div class="codehilite"><pre><span></span><code>gcloud services enable container.googleapis.com
</code></pre></div>

<p><strong>Step 2</strong> From the cloud shell, run the following command to create a cluster with 1 node:</p>
<div class="codehilite"><pre><span></span><code>gcloud beta container clusters create k8s-gmp-labs \
--region us-central1 \
--enable-ip-alias \
--enable-network-policy \
--num-nodes 1 \
--machine-type &quot;e2-standard-4&quot; \
--release-channel regular \
--enable-managed-prometheus
</code></pre></div>

<div class="codehilite"><pre><span></span><code>gcloud container clusters get-credentials k8s-gmp-labs --region us-central1
</code></pre></div>

<p><strong>Step 3</strong> List the Google Managed Prometheus (GMPs) Custom Resources Definitions (CRD's)</p>
<div class="codehilite"><pre><span></span><code>kubectl get crd | grep monitoring
</code></pre></div>

<div class="codehilite"><pre><span></span><code>clusterpodmonitorings.monitoring.googleapis.com       2022-07-12T20:26:52Z
clusterrules.monitoring.googleapis.com                2022-07-12T20:26:52Z
globalrules.monitoring.googleapis.com                 2022-07-12T20:26:53Z
operatorconfigs.monitoring.googleapis.com             2022-07-12T20:26:53Z
podmonitorings.monitoring.googleapis.com              2022-07-12T20:26:53Z
rules.monitoring.googleapis.com                       2022-07-12T20:26:54Z
</code></pre></div>

<h3 id="12-deploy-prom-example-application-and-scrape-custom-metrics-with-podmonitoring">1.2 Deploy <code>prom-example</code> application and scrape custom metrics with <code>PodMonitoring</code><a class="headerlink" href="#12-deploy-prom-example-application-and-scrape-custom-metrics-with-podmonitoring" title="Permanent link">&para;</a></h3>
<p>GMP out of the box doesn't scrape any metrics. In order to see any scraped Metrics in Prometheus UI or Grafana, 
we need to have deployed application and configure it as target for scraping using <code>PodMonitoring</code> CR.</p>
<p>We going to start by deploying application <code>example-app</code> in <code>default</code> namespace and adding it as scraping target:</p>
<p><strong>Step 1</strong> Deploy application <code>example-app</code> in <code>default</code> namespace:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt; EOF&gt;&gt; example-app.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: example-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: example-app
  template:
    metadata:
      labels:
        app: example-app
    spec:
      containers:
      - name: example-app
        image: fabxc/instrumented_app
        ports:
        - name: web
          containerPort: 8080
EOF
</code></pre></div>

<div class="codehilite"><pre><span></span><code>cat &lt;&lt; EOF&gt;&gt; example-svc.yaml
kind: Service
apiVersion: v1
metadata:
  name: example-app
  labels:
    app: example-app
spec:
  selector:
    app: example-app
  ports:
  - name: web
    port: 8080
EOF
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubens default
kubectl apply -f example-app.yaml
kubectl apply -f example-svc.yaml
</code></pre></div>

<p><strong>Step 2</strong> Deploy <code>PodMonitoring</code> in <code>default</code> namespace</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt; EOF&gt;&gt; example-pod-mon.yaml
apiVersion: monitoring.googleapis.com/v1
kind: PodMonitoring
metadata:
  name: example-app
spec:
  selector:
    matchLabels:
      app: example-app
  endpoints:
  - port: web
    interval: 30s
EOF
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl apply -f example-pod-mon.yaml
</code></pre></div>

<p>Verify <code>monitoring</code> has been created in <code>default</code> namespace</p>
<div class="codehilite"><pre><span></span><code>kubectl get -A podmonitorings.monitoring.googleapis.com
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Creation of <code>monitoring</code> can be done in application namespace as well</p>
</div>
<p><strong>Step 6</strong> Verify that your Prometheus data is being exported to Managed Service for Prometheus:</p>
<p>In the Google Cloud console, go to <code>Monitoring</code></p>
<p>In the Monitoring navigation pane, click <code>Managed Prometheus</code></p>
<p>Run following queries:</p>
<div class="codehilite"><pre><span></span><code>up
</code></pre></div>

<div class="codehilite"><pre><span></span><code>http_requests_total{code=&quot;200&quot;,method=&quot;get&quot;}
</code></pre></div>

<div class="admonition success">
<p class="admonition-title">Success</p>
<p>We can see Prometheus data is being exported to Managed Service for Prometheus</p>
</div>
<h2 id="2-configure-prometheus-ui-and-grafana-dashboards">2 Configure Prometheus UI and Grafana Dashboards<a class="headerlink" href="#2-configure-prometheus-ui-and-grafana-dashboards" title="Permanent link">&para;</a></h2>
<h3 id="21-verify-sa-account-has-correct-permissions">2.1 Verify SA account has correct permissions.<a class="headerlink" href="#21-verify-sa-account-has-correct-permissions" title="Permanent link">&para;</a></h3>
<p><strong>Option 1:</strong> Using GKE with <code>default</code> Compute Service Account, should have all required permissions as it is using Editor role (roles/editor) on the project. (without WI enabled)</p>
<p><strong>Option 2:</strong> Using GKE with custom Service Account for Nodes (without WI enabled)</p>
<p>Make sure default compute <code>SA</code> has <code>monitoring.metricWriter</code> and <code>monitoring.viewer</code> roles:</p>
<div class="codehilite"><pre><span></span><code>gcloud projects get-iam-policy $PROJECT_ID
</code></pre></div>

<p>If you have <code>Editor</code> role or <code>roles/monitoring.metricWriter</code> and <code>role: roles/monitoring.viewer</code> skip the step.
Otherwise add following roles tp SA.</p>
<div class="codehilite"><pre><span></span><code>gcloud projects add-iam-policy-binding $PROJECT_ID \
 --member=&#39;serviceAccount:$PROJECT_NUMBER-compute@developer.gserviceaccount.com&#39; \
 --role=roles/monitoring.metricWriter

gcloud projects add-iam-policy-binding $PROJECT_ID \
 --member=&#39;serviceAccount:$PROJECT_NUMBER-compute@developer.gserviceaccount.com&#39; \
 --role=roles/monitoring.viewer
</code></pre></div>

<p><strong>Option 3:</strong> If using GKE with WI, follow the <a href="https://cloud.google.com/stackdriver/docs/managed-prometheus/setup-unmanaged#gmp-wli-svcacct">Configure a service account for Workload Identity</a> instructions</p>
<p><strong>Option 4:</strong> If using Non-GKE Kubernetes clusters, follow the <a href="https://cloud.google.com/stackdriver/docs/managed-prometheus/setup-unmanaged#explicit-credentials">Provide credentials explicitly</a> instructions</p>
<h3 id="22-setup-prometheus-ui-for-gmp">2.2 Setup Prometheus UI for GMP<a class="headerlink" href="#22-setup-prometheus-ui-for-gmp" title="Permanent link">&para;</a></h3>
<p>In order to see if GMP is working and scraping metric, GCP provides Prometheus UI <code>frontend</code> image.</p>
<p>To deploy the Prometheus UI for Managed Service for Prometheus, run the following commands.</p>
<p><strong>Step 1</strong>  Deploy the <code>Prometheus UI</code> frontend service inside of namespace where Grafana going to be installed (or already installed))</p>
<div class="codehilite"><pre><span></span><code>export GRAFANA_NAMESPACE=grafana
</code></pre></div>

<div class="codehilite"><pre><span></span><code>curl https://raw.githubusercontent.com/GoogleCloudPlatform/prometheus-engine/v0.4.1/examples/frontend.yaml |
sed &#39;s/\$PROJECT_ID/gcp-demos-331123/&#39; |
kubectl apply -n $GRAFANA_NAMESPACE -f -
</code></pre></div>

<p><strong>Step 2</strong>  Port-forward the <code>frontend</code> service to your local machine. The following example forwards the service to port 9090:</p>
<div class="codehilite"><pre><span></span><code>kubectl -n $GRAFANA_NAMESPACE port-forward svc/frontend 8080:9090
</code></pre></div>

<p>You can access the Prometheus UI in your by using the Web Preview button.</p>
<p>The following screenshot shows a table in the Prometheus UI that displays the <code>up{cluster="k8s-gmp-labs"}</code> metric:</p>
<p><img alt="alt text" src="../images/gmp_ui.png" /></p>
<div class="admonition result">
<p class="admonition-title">Result</p>
<p>We can see that all pods from <code>example-app</code> and <code>prom-example</code> are being scraped.</p>
</div>
<p><strong>Step 3</strong> Observe  and try to build a dashboards using on the exposed Prometheus metrics emitted by <code>example-app</code> app:</p>
<p>The following metrics are exposed:</p>
<ul>
<li><code>version</code> - of type <em>gauge</em> - containing the app version - as a constant metric value <code>1</code> and label <code>version</code>, representing this app version</li>
<li><code>http_requests_total</code> - of type <em>counter</em> - representing the total numbere of incoming HTTP requests</li>
</ul>
<p>The sample output of the <code>/metric</code> endpoint after 5 incoming HTTP requests shown below.</p>
<p>Note: with no initial incoming request, only <code>version</code> metric is reported.</p>
<div class="codehilite"><pre><span></span><code># HELP http_requests_total Count of all HTTP requests
# TYPE http_requests_total counter
http_requests_total{code=&quot;200&quot;,method=&quot;get&quot;}
# HELP version Version information about this binary
# TYPE version gauge
version{version=&quot;v0.3.0&quot;} 1
</code></pre></div>

<h3 id="23-use-grafana-with-gmp">2.3 Use Grafana with GMP<a class="headerlink" href="#23-use-grafana-with-gmp" title="Permanent link">&para;</a></h3>
<h4 id="231-install-grafana">2.3.1 Install Grafana<a class="headerlink" href="#231-install-grafana" title="Permanent link">&para;</a></h4>
<p>Google Cloud APIs all require authentication using OAuth2; however, Grafana doesn't support OAuth2 authentication for Prometheus data sources. To use Grafana with Managed Service for Prometheus, we've deployed Prometheus UI as an authentication proxy in a previous step.</p>
<p><strong>Option 1:</strong> Configure existing Grafana Dashboard to use GMP</p>
<p>If you would like to take advantage of you existing Dashboards and already deployed Grafana,
the only steps needed is to create a <code>Data Source</code> for Google Managed Prometheus described in this <a href="https://cloud.google.com/stackdriver/docs/managed-prometheus/query#ui-grafana">reference</a></p>
<p>Once configured you can redirect existing dashboards to the new <code>Data Source</code>, or create the new once.</p>
<p><strong>Option 2:</strong> Configure Grafana Dashboard that comes with GMP </p>
<p>Configure Grafana Dashboard that comes with GMP, following this <a href="https://cloud.google.com/stackdriver/docs/managed-prometheus/query#grafana-deploy">steps</a></p>
<p>If you don't have a running Grafana deployment in your cluster, then you can create an ephemeral test deployment to experiment with.</p>
<p>To create an ephemeral Grafana deployment, apply the Managed Service for Prometheus grafana.yaml manifest to your cluster, and port-forward the grafana service to your local machine. The following example forwards the service to port 3000.</p>
<div class="codehilite"><pre><span></span><code>kubectl -n gmp-test apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/prometheus-engine/v0.4.1/examples/grafana.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl -n $GRAFANA_NAMESPACE port-forward svc/grafana 8080:3000
</code></pre></div>

<p><strong>Option 3:</strong> Use Grafana Helm Charts or Grafana Operator</p>
<p>For production deployment it is preferred to use  <a href="https://artifacthub.io/packages/helm/grafana/grafana">Grafana Helm Chart</a> or <a href="https://artifacthub.io/packages/olm/community-operators/grafana-operator">Grafana Operator</a> as you can define and recreate you dashboards via json or CRDs in consistent manner.</p>
<h4 id="232-configure-grafana-to-work-with-gmp">2.3.2 Configure Grafana to work with GMP<a class="headerlink" href="#232-configure-grafana-to-work-with-gmp" title="Permanent link">&para;</a></h4>
<p>To query Managed Service for Prometheus in Grafana by using the Prometheus UI as the authentication proxy, you must add new data source to Grafana. </p>
<p>To add a data source for the managed service use following <a href="https://cloud.google.com/stackdriver/docs/managed-prometheus/query#grafana-deploy">reference documenation</a></p>
<h2 id="3-verify-gmp-cost">3 Verify GMP Cost<a class="headerlink" href="#3-verify-gmp-cost" title="Permanent link">&para;</a></h2>
<p><strong>Option 1</strong> Estimate Cost based on ingested metrics.</p>
<p><em>Step 1</em> Create a new Grafana Dashboard:</p>
<div class="codehilite"><pre><span></span><code>Data Source: Managed Service for Prometheus

Metric Browser: `rate(gcm_export_samples_exported_total{job=~&quot;.+&quot;,instance=~&quot;.+&quot;}[5m])`

Step: 10
</code></pre></div>

<p><img alt="alt text" src="../images/gmp_cost_calculation.png" /></p>
<p>Example calculation:</p>
<p>N1. 770 Samples per second based on Dashboard value</p>
<p>N2. 770 samples per second * 2628000 seconds/mo = 2023 B samples/mo</p>
<p>N3. Since $0.15/million samples: first 0-50 billion samples#  <a href="https://cloud.google.com/stackdriver/pricing#monitoring-costs">Reference N1</a>  </p>
<p>N4. We can calculate final cost: 2023 B samples/mo * 0.15 = ~303$ per month </p>
<p><strong>Option 2</strong> View your Google Cloud bill</p>
<ol>
<li>
<p>In the Google Cloud console, go to the Billing page.</p>
</li>
<li>
<p>If you have more than one billing account, select Go to linked billing account to view the current project's billing account. To locate a different billing account, select Manage billing accounts and choose the account for which you'd like to get usage reports.</p>
</li>
<li>
<p>Select Reports.</p>
</li>
<li>
<p>From the Services menu, select the Stackdriver Monitoring option.</p>
</li>
<li>
<p>From the SKUs menu, select the following options:</p>
</li>
<li>
<p>Prometheus Samples Ingested</p>
</li>
<li>Monitoring API Requests</li>
</ol>
<h2 id="4-cleanup">4 Cleanup<a class="headerlink" href="#4-cleanup" title="Permanent link">&para;</a></h2>
<p>Delete Kubernetes cluster as it will enquire cost both for GKE and GMP.</p>
<p>Delete GKE cluster:</p>
<div class="codehilite"><pre><span></span><code>gcloud container clusters delete k8s-gmp-labs --region us-central1
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../prometheus-operator-to-gmp/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Prometheus-operator scraping metrics to GMP
            </div>
          </div>
        </a>
      
      
        <a href="../gmp-with-gkestandard-flientbit/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              GMP scraping Fluent-bit metrics (WIP)
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://twitter.com/googlecloud" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.4ea5477f.min.js"></script>
      
    
  </body>
</html>