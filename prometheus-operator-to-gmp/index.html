
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.3">
    
    
      
        <title>Prometheus-operator scraping metrics to GMP - GMP Hack Days</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e35208c4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#prometheus-operator-scraping-metrics-to-gmp" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="GMP Hack Days" class="md-header__button md-logo" aria-label="GMP Hack Days" data-md-component="logo">
      
  <img src="../images/prometheus.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            GMP Hack Days
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Prometheus-operator scraping metrics to GMP
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="GMP Hack Days" class="md-nav__button md-logo" aria-label="GMP Hack Days" data-md-component="logo">
      
  <img src="../images/prometheus.png" alt="logo">

    </a>
    GMP Hack Days
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      <label class="md-nav__link" for="__nav_2">
        Self-deployed collection
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Self-deployed collection" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Self-deployed collection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Prometheus-operator scraping metrics to GMP
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Prometheus-operator scraping metrics to GMP
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-configure-prometheus-operator-on-gke" class="md-nav__link">
    1 Configure Prometheus Operator on GKE
  </a>
  
    <nav class="md-nav" aria-label="1 Configure Prometheus Operator on GKE">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-create-regional-gke-cluster-on-gcp" class="md-nav__link">
    1.1 Create Regional GKE Cluster on GCP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-install-prometheus-operator-and-grafana-helm-charts" class="md-nav__link">
    1.2 Install Prometheus Operator and Grafana Helm Charts
  </a>
  
    <nav class="md-nav" aria-label="1.2 Install Prometheus Operator and Grafana Helm Charts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121-install-kube-prometheus-stack-helm-chart" class="md-nav__link">
    1.2.1 Install kube-prometheus-stack helm chart
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122-observe-grafana-dashboards" class="md-nav__link">
    1.2.2 Observe Grafana Dashboards
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#123-optional-deploy-onlineboutique-application-and-observe-app-compute-resources" class="md-nav__link">
    1.2.3 (Optional) Deploy onlineboutique application and observe app compute resources
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#124-deploy-application-and-scrape-custom-metrics-with-podmonitor" class="md-nav__link">
    1.2.4 Deploy application and scrape custom metrics with PodMonitor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#125-deploy-application-and-scrape-custom-metrics-with-servicemonitor" class="md-nav__link">
    1.2.5 Deploy application and scrape custom metrics with ServiceMonitor
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-migrate-from-prometheus-operator-to-google-managed-prometheus-with-self-deployed-collection" class="md-nav__link">
    2 Migrate from Prometheus Operator to Google Managed Prometheus with self-deployed collection
  </a>
  
    <nav class="md-nav" aria-label="2 Migrate from Prometheus Operator to Google Managed Prometheus with self-deployed collection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#20-prerequisite" class="md-nav__link">
    2.0 Prerequisite
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#21-setup-gmp-collection" class="md-nav__link">
    2.1 Setup GMP Collection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-verify-gmp-collection" class="md-nav__link">
    2.2 Verify GMP Collection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-setup-prometheus-ui-for-gmp" class="md-nav__link">
    2.3 Setup Prometheus UI for GMP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-setup-grafana-for-gmp" class="md-nav__link">
    2.4 Setup Grafana for GMP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-verify-gmp-cost" class="md-nav__link">
    2.5 Verify GMP Cost
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-cleanup" class="md-nav__link">
    7 Cleanup
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        Managed collection with GKE Standard
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Managed collection with GKE Standard" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Managed collection with GKE Standard
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../gmp-with-gkestandard-custom/" class="md-nav__link">
        GMP scraping Custom App metrics
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../gmp-with-gkestandard-flientbit/" class="md-nav__link">
        GMP scraping Fluent-bit metrics
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../gmp-with-gkestandard-nginxingress/" class="md-nav__link">
        GMP scraping Nginx-Ingress metrics
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../gmp-for-gcp-cloud-resources/" class="md-nav__link">
        GMP quering Google Cloud Metrics with PromQL and Grafana
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../gmp-multi-tenant/" class="md-nav__link">
        Centralized Multi-tenant GMP setup with GKE Clusters in Different Projects
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        Managed collection with GKE Autopilot
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Managed collection with GKE Autopilot" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Managed collection with GKE Autopilot
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../gmp-with-gkeautopilot/" class="md-nav__link">
        GMP setup with single GKE Autopilot
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        Setting up GMP with Terraform
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Setting up GMP with Terraform" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Setting up GMP with Terraform
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../gmp-with-terraform/" class="md-nav__link">
        Automate GMP deployument with Terraform
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        Setting up GMP with KCC
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Setting up GMP with KCC" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Setting up GMP with KCC
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../gmp-with-kcc/" class="md-nav__link">
        Automate GMP deployument with KCC
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      <label class="md-nav__link" for="__nav_7">
        Managed Prometheus AlertManager
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Managed Prometheus AlertManager" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Managed Prometheus AlertManager
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../gmp-alertmanager/" class="md-nav__link">
        GMP Managed Prometheus AlertManager
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-configure-prometheus-operator-on-gke" class="md-nav__link">
    1 Configure Prometheus Operator on GKE
  </a>
  
    <nav class="md-nav" aria-label="1 Configure Prometheus Operator on GKE">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-create-regional-gke-cluster-on-gcp" class="md-nav__link">
    1.1 Create Regional GKE Cluster on GCP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-install-prometheus-operator-and-grafana-helm-charts" class="md-nav__link">
    1.2 Install Prometheus Operator and Grafana Helm Charts
  </a>
  
    <nav class="md-nav" aria-label="1.2 Install Prometheus Operator and Grafana Helm Charts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121-install-kube-prometheus-stack-helm-chart" class="md-nav__link">
    1.2.1 Install kube-prometheus-stack helm chart
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122-observe-grafana-dashboards" class="md-nav__link">
    1.2.2 Observe Grafana Dashboards
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#123-optional-deploy-onlineboutique-application-and-observe-app-compute-resources" class="md-nav__link">
    1.2.3 (Optional) Deploy onlineboutique application and observe app compute resources
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#124-deploy-application-and-scrape-custom-metrics-with-podmonitor" class="md-nav__link">
    1.2.4 Deploy application and scrape custom metrics with PodMonitor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#125-deploy-application-and-scrape-custom-metrics-with-servicemonitor" class="md-nav__link">
    1.2.5 Deploy application and scrape custom metrics with ServiceMonitor
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-migrate-from-prometheus-operator-to-google-managed-prometheus-with-self-deployed-collection" class="md-nav__link">
    2 Migrate from Prometheus Operator to Google Managed Prometheus with self-deployed collection
  </a>
  
    <nav class="md-nav" aria-label="2 Migrate from Prometheus Operator to Google Managed Prometheus with self-deployed collection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#20-prerequisite" class="md-nav__link">
    2.0 Prerequisite
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#21-setup-gmp-collection" class="md-nav__link">
    2.1 Setup GMP Collection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-verify-gmp-collection" class="md-nav__link">
    2.2 Verify GMP Collection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-setup-prometheus-ui-for-gmp" class="md-nav__link">
    2.3 Setup Prometheus UI for GMP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-setup-grafana-for-gmp" class="md-nav__link">
    2.4 Setup Grafana for GMP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-verify-gmp-cost" class="md-nav__link">
    2.5 Verify GMP Cost
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-cleanup" class="md-nav__link">
    7 Cleanup
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="prometheus-operator-scraping-metrics-to-gmp">Prometheus-operator scraping metrics to GMP<a class="headerlink" href="#prometheus-operator-scraping-metrics-to-gmp" title="Permanent link">&para;</a></h1>
<h2 id="1-configure-prometheus-operator-on-gke">1 Configure Prometheus Operator on GKE<a class="headerlink" href="#1-configure-prometheus-operator-on-gke" title="Permanent link">&para;</a></h2>
<p>The <code>Prometheus</code> Operator is a tool developed and opnesourced by CoreOS that aims to automate manual operations of Prometheus and Alertmanager on Kubernetes using Kubernetes Custom Resource Definitions (CRDs).</p>
<p>The <code>Prometheus</code> Operator provides easy monitoring definitions for Kubernetes services and deployment and management of Prometheus instances.</p>
<p>Once installed, the Prometheus Operator provides the following features:</p>
<ul>
<li><strong>Kubernetes Custom Resources:</strong> Use <code>Kubernetes</code> custom resources to deploy and manage <code>Prometheus</code>, <code>Alertmanager</code>, and related components.</li>
<li><strong>Simplified Deployment Configuration:</strong> Configure the fundamentals of Prometheus like versions, persistence, retention policies, and replicas from a native Kubernetes resource.</li>
<li><strong>Target Services via Labels:</strong> Automatically generate monitoring target configurations based on familiar Kubernetes label queries; no need to learn a Prometheus specific configuration language.</li>
</ul>
<p><strong>Objective:</strong></p>
<ul>
<li>Explore the operators' deployment setup</li>
<li>Configure <code>ServiceMonitor</code>, which declaratively specifies how groups of Kubernetes services should be monitored. The Operator automatically generates Prometheus scrape configuration based on the current state of the objects in the API server.</li>
<li>Configure <code>PrometheusRule</code> and <code>AlertmanagerConfig</code> to be able to send Slack alerts</li>
</ul>
<h3 id="11-create-regional-gke-cluster-on-gcp">1.1 Create Regional GKE Cluster on GCP<a class="headerlink" href="#11-create-regional-gke-cluster-on-gcp" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong> Enable the Google Kubernetes Engine API.</p>
<div class="codehilite"><pre><span></span><code>gcloud services enable container.googleapis.com
</code></pre></div>

<p><strong>Step 2</strong> From the cloud shell, run the following command to create a cluster with 1 node:</p>
<div class="codehilite"><pre><span></span><code>gcloud container clusters create k8s-prometheus-labs \
--region us-central1 \
--enable-ip-alias \
--enable-network-policy \
--num-nodes 1 \
--machine-type &quot;e2-standard-4&quot; \
--release-channel regular
</code></pre></div>

<div class="codehilite"><pre><span></span><code>gcloud container clusters get-credentials k8s-prometheus-labs --region us-central1
</code></pre></div>

<p><strong>Step 3: (Optional)</strong> Setup <code>kubectx</code> and <code>kubens</code></p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p><code>kubectx</code> + <code>kubens</code>: Power tools for <code>kubectl</code>:
- <code>kubectx</code> helps you switch between clusters back and forth
- <code>kubens</code> helps you switch between Kubernetes namespaces smoothly</p>
</div>
<p>Install As <a href="https://github.com/ahmetb/kubectx#kubectl-plugins-macos-and-linux">kubectl plugins(macOS &amp; Linux)</a></p>
<div class="codehilite"><pre><span></span><code>kubectl krew install ctx
kubectl krew install ns
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Google Cloud Console comes with <code>kubectx</code> and <code>kubens</code> setup.
However above steps can be used to setup your local shell.</p>
</div>
<h3 id="12-install-prometheus-operator-and-grafana-helm-charts">1.2 Install Prometheus Operator and Grafana Helm Charts<a class="headerlink" href="#12-install-prometheus-operator-and-grafana-helm-charts" title="Permanent link">&para;</a></h3>
<h4 id="121-install-kube-prometheus-stack-helm-chart">1.2.1 Install <code>kube-prometheus-stack</code> helm chart<a class="headerlink" href="#121-install-kube-prometheus-stack-helm-chart" title="Permanent link">&para;</a></h4>
<p><strong>kube-prometheus</strong>
<a href="https://github.com/prometheus-operator/kube-prometheus">kube-prometheus</a> provides example configurations for a complete cluster monitoring
stack based on Prometheus and the Prometheus Operator.  This includes deployment of multiple Prometheus and Alertmanager instances,
metrics exporters such as the node_exporter for gathering node metrics, scrape target configuration linking Prometheus to various
metrics endpoints, and example alerting rules for notification of potential issues in the cluster.</p>
<p><strong>helm chart</strong>
The <a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack">prometheus-community/kube-prometheus-stack</a>
helm chart provides a similar feature set to kube-prometheus. For more information, please see the <a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack#kube-prometheus-stack">chart's readme</a></p>
<p><strong>Step 1</strong> Configure <code>Helm</code> repository</p>
<div class="codehilite"><pre><span></span><code>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
</code></pre></div>

<p><strong>Step 2</strong> Fetch  <code>Helm</code> repository to local filesystem</p>
<div class="codehilite"><pre><span></span><code>mkdir ~/gmp-setup
cd ~/gmp-setup
</code></pre></div>

<div class="codehilite"><pre><span></span><code>helm pull prometheus-community/kube-prometheus-stack --version 35.6.0
tar -xvzf kube-prometheus-stack-35.6.0.tgz
cd kube-prometheus-stack
tree -L 2
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>── charts
│   ├── grafana
│   ├── kube-state-metrics
│   └── prometheus-node-exporter
├── crds
│   ├── crd-alertmanagerconfigs.yaml
│   ├── crd-alertmanagers.yaml
│   ├── crd-podmonitors.yaml
│   ├── crd-probes.yaml
│   ├── crd-prometheuses.yaml
│   ├── crd-prometheusrules.yaml
│   ├── crd-servicemonitors.yaml
│   └── crd-thanosrulers.yaml
├── templates
│   ├── NOTES.txt
│   ├── _helpers.tpl
│   ├── alertmanager
│   ├── exporters
│   │   ├── core-dns
│   │   ├── kube-api-server
│   │   ├── kube-controller-manager
│   │   ├── kube-dns
│   │   ├── kube-etcd
│   │   ├── kube-proxy
│   │   ├── kube-scheduler
│   │   ├── kube-state-metrics
│   │   ├── kubelet
│   │   └── node-exporter
│   ├── grafana
│   ├── prometheus
│   └── prometheus-operator
└── values.yaml
</code></pre></div>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>This chart is maintained by the Prometheus community and contains everything you need to get started including:</p>
<ul>
<li><code>prometheus operator</code></li>
<li><code>alertmanager</code></li>
<li><code>grafana</code> with predefined dashboards</li>
<li><code>prometheus-node-exporter</code> - Prometheus exporter for hardware and OS metrics exposed by *NIX kernels, written in Go with pluggable metric collectors</li>
<li>Kubernetes Control and Data plane  <code>exporters</code> such as <code>kube-api-server</code>, <code>core-dns</code>, <code>kube-controller-manager</code>, <code>kube-etcd</code>, <code>kube-scheduler</code>, <code>kubelet</code></li>
<li><code>kube-state-metrics</code> - is a simple service that listens to the Kubernetes API server and generates metrics about the state of the objects</li>
</ul>
</div>
<p><strong>Step 3</strong> Create custom Grafana configuration, that will allow to expose Grafana Dashboard:</p>
<p>Option 1 Ingress</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt; EOF&gt;&gt; grafana_values.yaml
grafana:
  adminPassword: admin
  ingress:
    enabled: true
    path: /*
    pathType: ImplementationSpecific
  service:
    type: NodePort
EOF
</code></pre></div>

<p>Option 1 LoadBalancer</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt; EOF&gt;&gt; grafana_values.yaml
grafana:
  adminPassword: admin
  service:
    type: LoadBalancer
EOF
</code></pre></div>

<p><strong>Step 4</strong> Install Helm Chart to <code>monitoring</code> namespace</p>
<div class="codehilite"><pre><span></span><code>kubectl create ns monitoring
kubens monitoring
helm install prometheus-stack prometheus-community/kube-prometheus-stack --version 35.6.0 --values grafana_values.yaml
</code></pre></div>

<h4 id="122-observe-grafana-dashboards">1.2.2 Observe Grafana Dashboards<a class="headerlink" href="#122-observe-grafana-dashboards" title="Permanent link">&para;</a></h4>
<p><strong>Step 1:</strong> Locate Grafana Dashboard URL:</p>
<div class="codehilite"><pre><span></span><code>kubectl get svc prometheus-stack-grafana
kubectl get ing
</code></pre></div>

<p><strong>Step 2:</strong> Launch the Grafana Dashboard and see Predefined Dashboards:</p>
<div class="codehilite"><pre><span></span><code>loadbalancer_ip
</code></pre></div>

<p>We've setup <code>admin</code> user password as: <code>admin</code>. So we will use this values to login to Grafana dashboard:</p>
<div class="codehilite"><pre><span></span><code>admin/admin
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>You should see your Grafana interface</p>
</div>
<p><strong>Step 2</strong> Access Grafana Dashboard and see Predefined Dashboards:</p>
<p><img alt="alt text" src="../images/grafana_dashboard.png" /></p>
<p><strong>Step 3</strong> Observe following Dashboards:</p>
<div class="codehilite"><pre><span></span><code>General /Kubernetes / Compute Resources / Cluster
</code></pre></div>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Observe Usage, Totals, Quotas, Requests for Memory and CPU per namespace
This values could be good input for Pods <code>requests</code> and <code>limits</code> measurements</p>
</div>
<div class="codehilite"><pre><span></span><code>General /Kubernetes / Compute Resources / Nodes (Pods)
</code></pre></div>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Observe CPU and Memory per Node</p>
</div>
<div class="codehilite"><pre><span></span><code>General /Kubernetes / Compute Resources / Namespace (Pods)
</code></pre></div>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Observe CPU and Memory per Pods</p>
</div>
<p>Observe Dashboards for Control Plane monitoring:</p>
<div class="codehilite"><pre><span></span><code>General / Kubernetes / API server
General / Kubernetes / Kubelet
General / Kubernetes / Scheduler
General / Kubernetes / Controller Manager
General / etcd
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>some of the Dashboards (etcd, Scheduler, Controller Manager) are empty, this is because GKE is Managed Kubernetes so some metrics are not available for scraping.</p>
</div>
<h4 id="123-optional-deploy-onlineboutique-application-and-observe-app-compute-resources">1.2.3 (Optional) Deploy onlineboutique application and observe app compute resources<a class="headerlink" href="#123-optional-deploy-onlineboutique-application-and-observe-app-compute-resources" title="Permanent link">&para;</a></h4>
<p>Deploy microservices application <code>onlineboutique</code>:</p>
<p><strong>Step 1</strong> Create Namespace <code>onlineboutique</code></p>
<div class="codehilite"><pre><span></span><code>kubectl create ns onlineboutique
</code></pre></div>

<p><strong>Step 2</strong> Deploy Microservice application</p>
<div class="codehilite"><pre><span></span><code>git clone https://github.com/GoogleCloudPlatform/microservices-demo.git
cd microservices-demo
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubens onlineboutique
kubectl apply -f ./release/kubernetes-manifests.yaml
</code></pre></div>

<p><strong>Step 3</strong> Verify Deployment:</p>
<div class="codehilite"><pre><span></span><code>kubectl get pods
</code></pre></div>

<p><strong>Step 4</strong> Observe following Dashboards:</p>
<div class="codehilite"><pre><span></span><code>General /Kubernetes / Compute Resources / Namespace (Pods)
General /Kubernetes / Compute Resources / Namespace (Workloads)
</code></pre></div>

<p>Choose:
  * Relative time ranges: <code>Last 15 minutes</code>
  * Namespace: <code>onlineboutique</code></p>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Observe CPU and Memory per Pods</p>
</div>
<h4 id="124-deploy-application-and-scrape-custom-metrics-with-podmonitor">1.2.4 Deploy application and scrape custom metrics with <code>PodMonitor</code><a class="headerlink" href="#124-deploy-application-and-scrape-custom-metrics-with-podmonitor" title="Permanent link">&para;</a></h4>
<p>Deploy application <code>prom-example</code>:</p>
<p><strong>Step 1</strong> Create Namespace <code>prom-test</code></p>
<div class="codehilite"><pre><span></span><code>kubectl create ns prom-test
kubens prom-test
</code></pre></div>

<p><strong>Step 2</strong> Create deployment <code>prom-example</code></p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt; EOF&gt;&gt; prom-example.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prom-example
  labels:
    app: prom-example
spec:
  selector:
    matchLabels:
      app: prom-example
  replicas: 3
  template:
    metadata:
      labels:
        app: prom-example
    spec:
      containers:
      - image: nilebox/prometheus-example-app@sha256:dab60d038c5d6915af5bcbe5f0279a22b95a8c8be254153e22d7cd81b21b84c5
        name: prom-example
        ports:
        - name: metrics
          containerPort: 1234
        command:
        - &quot;/main&quot;
        - &quot;--process-metrics&quot;
        - &quot;--go-metrics&quot;
EOF
</code></pre></div>

<p><strong>Step 4</strong> Deploy <code>prom-example</code> application</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f prom-example.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl get pods
</code></pre></div>

<p><strong>Step 5</strong> List the Prometheus Operator Custom Resources Definitions (CRD's)</p>
<div class="codehilite"><pre><span></span><code>kubectl get crd | grep monitoring
</code></pre></div>

<p><strong>Step 6</strong> Scrape Pod Metrics using <code>PodMonitor</code> crd</p>
<p>The operator uses <code>ServiceMonitors</code> or <code>PodMonitor</code> to define a set of targets to be monitored by Prometheus. It uses label selectors to define which <code>Services</code> or <code>Pod</code> to monitor, the namespaces to look for, and the port on which the metrics are exposed.</p>
<p>First let's find out how <code>kind: Prometheus</code> will select <code>PodMonitor</code> using <code>serviceMonitorSelector</code> ?</p>
<div class="codehilite"><pre><span></span><code>kubens monitoring
kubectl get prometheuses.monitoring.coreos.com prometheus-stack-kube-prom-prometheus -o yaml | grep -C5 podMonitorSelector
</code></pre></div>

<p><strong>Output:</strong> </p>
<div class="codehilite"><pre><span></span><code>  podMonitorSelector:
    matchLabels:
      release: prometheus-stack
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Prometheus Operator will select all <code>podMonitor</code> that match match label: <code>release: prometheus-stack</code></p>
</div>
<p>Create a file <code>pod-monitor.yaml</code> with the following content to add a <code>PodMonitor</code> so that the Prometheus server scrapes only its own metrics endpoints:</p>
<p>Define a PodMonitor in a manifest file <code>podmonitor.yaml</code> by selecting <code>app: prom-example</code> labels in namespace <code>prom-test</code> and scrape metrics from <code>port: metrics</code>. Define <code>PodMonitor</code> labels as <code>release: prometheus-stack</code>, so that Prometheus operator can select them. </p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt; EOF&gt;&gt; podmonitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: prom-example
  labels:
    release: prometheus-stack
spec:
  namespaceSelector:
    matchNames:
      - prom-test
  selector:
    matchLabels:
      app: prom-example
  podMetricsEndpoints:
  - port: metrics
EOF
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl apply -f podmonitor.yaml
</code></pre></div>

<p><strong>Step 3</strong> Observe that <code>PodMonitor</code> been picked up by Prometheus Operator</p>
<div class="codehilite"><pre><span></span><code>kubectl -n monitoring get secret prometheus-prometheus-stack-kube-prom-prometheus -ojson | jq -r &#39;.data[&quot;prometheus.yaml.gz&quot;]&#39; | base64 -d | gunzip | grep &quot;prom-example&quot;
</code></pre></div>

<h4 id="125-deploy-application-and-scrape-custom-metrics-with-servicemonitor">1.2.5 Deploy application and scrape custom metrics with <code>ServiceMonitor</code><a class="headerlink" href="#125-deploy-application-and-scrape-custom-metrics-with-servicemonitor" title="Permanent link">&para;</a></h4>
<p><strong>Step 1</strong> Deploy application <code>example-app</code> in <code>default</code> namespace:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt; EOF&gt;&gt; example-app.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: example-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: example-app
  template:
    metadata:
      labels:
        app: example-app
    spec:
      containers:
      - name: example-app
        image: fabxc/instrumented_app
        ports:
        - name: web
          containerPort: 8080
EOF
</code></pre></div>

<div class="codehilite"><pre><span></span><code>cat &lt;&lt; EOF&gt;&gt; example-svc.yaml
kind: Service
apiVersion: v1
metadata:
  name: example-app
  labels:
    app: example-app
spec:
  selector:
    app: example-app
  ports:
  - name: web
    port: 8080
EOF
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubens default
kubectl apply -f example-app.yaml
kubectl apply -f example-svc.yaml
</code></pre></div>

<p><strong>Step 2</strong> Deploy <code>ServiceMonitor</code> in <code>monitoring</code> namespace</p>
<p>First let's find out how <code>kind: Prometheus</code> will select <code>PodMonitor</code> using <code>serviceMonitorSelector</code> ?</p>
<div class="codehilite"><pre><span></span><code>kubens monitoring
kubectl get prometheuses.monitoring.coreos.com prometheus-stack-kube-prom-prometheus -o yaml | grep -C5 serviceMonitorSelector
</code></pre></div>

<p><strong>Output:</strong> </p>
<div class="codehilite"><pre><span></span><code>  podMonitorSelector:
    matchLabels:
      release: prometheus-stack
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Prometheus Operator will select all <code>podMonitor</code> that match match label: <code>release: prometheus-stack</code></p>
</div>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt; EOF&gt;&gt; example-svc-mon.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: example-app
  labels:
    release: prometheus-stack
spec:
  namespaceSelector:
    matchNames:
      - default
  selector:
    matchLabels:
      app: example-app
  endpoints:
  - port: web
EOF
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubens monitoring
kubectl apply -f example-svc-mon.yaml
</code></pre></div>

<p>Verify <code>servicemonitor</code> has been created in <code>monitoring</code> namespace</p>
<div class="codehilite"><pre><span></span><code>kubectl get -A servicemonitor.monitoring.coreos.com
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Creation of <code>servicemonitor</code> can be done in application namespace as well</p>
</div>
<p><strong>Step 3</strong> Observe that ServiceMonitor been picked up by Prometheus Operator</p>
<div class="codehilite"><pre><span></span><code>kubectl -n monitoring get secret prometheus-prometheus-stack-kube-prom-prometheus -ojson | jq -r &#39;.data[&quot;prometheus.yaml.gz&quot;]&#39; | base64 -d | gunzip | grep &quot;example-app&quot;
</code></pre></div>

<p><strong>Step 4</strong> Observe Prometheus UI and check that <code>servicemonitor</code> has been discovered under <code>Targets</code> and <code>ServiceDiscovery</code>:</p>
<div class="codehilite"><pre><span></span><code>kubectl port-forward svc/prometheus-stack-kube-prom-prometheus  8080:9090
</code></pre></div>

<p><strong>Step 5</strong> <strong>Step 4</strong> Observe Grafana UI and try to build a dashboards using on the exposed Prometheus metrics emitted by <code>example-app</code> app:</p>
<p>The following metrics are exposed:</p>
<ul>
<li><code>version</code> - of type <em>gauge</em> - containing the app version - as a constant metric value <code>1</code> and label <code>version</code>, representing this app version</li>
<li><code>http_requests_total</code> - of type <em>counter</em> - representing the total numbere of incoming HTTP requests</li>
<li><code>http_request_duration_seconds</code> - of type <em>histogram</em>, representing duration of all HTTP requests</li>
<li><code>http_request_duration_seconds_count</code>- total count of all incoming HTTP requeests</li>
<li><code>http_request_duration_seconds_sum</code> - total duration in seconds of all incoming HTTP requests</li>
<li><code>http_request_duration_seconds_bucket</code> - a histogram representation of the duration of the incoming HTTP requests</li>
</ul>
<p>The sample output of the <code>/metric</code> endpoint after 5 incoming HTTP requests shown below.</p>
<p>Note: with no initial incoming request, only <code>version</code> metric is reported.</p>
<div class="codehilite"><pre><span></span><code># HELP http_request_duration_seconds Duration of all HTTP requests
# TYPE http_request_duration_seconds histogram
http_request_duration_seconds_bucket{code=&quot;200&quot;,handler=&quot;found&quot;,method=&quot;get&quot;,le=&quot;0.005&quot;} 5
http_request_duration_seconds_bucket{code=&quot;200&quot;,handler=&quot;found&quot;,method=&quot;get&quot;,le=&quot;0.01&quot;} 5
http_request_duration_seconds_bucket{code=&quot;200&quot;,handler=&quot;found&quot;,method=&quot;get&quot;,le=&quot;0.025&quot;} 5
http_request_duration_seconds_bucket{code=&quot;200&quot;,handler=&quot;found&quot;,method=&quot;get&quot;,le=&quot;0.05&quot;} 5
http_request_duration_seconds_bucket{code=&quot;200&quot;,handler=&quot;found&quot;,method=&quot;get&quot;,le=&quot;0.1&quot;} 5
http_request_duration_seconds_bucket{code=&quot;200&quot;,handler=&quot;found&quot;,method=&quot;get&quot;,le=&quot;0.25&quot;} 5
http_request_duration_seconds_bucket{code=&quot;200&quot;,handler=&quot;found&quot;,method=&quot;get&quot;,le=&quot;0.5&quot;} 5
http_request_duration_seconds_bucket{code=&quot;200&quot;,handler=&quot;found&quot;,method=&quot;get&quot;,le=&quot;1&quot;} 5
http_request_duration_seconds_bucket{code=&quot;200&quot;,handler=&quot;found&quot;,method=&quot;get&quot;,le=&quot;2.5&quot;} 5
http_request_duration_seconds_bucket{code=&quot;200&quot;,handler=&quot;found&quot;,method=&quot;get&quot;,le=&quot;5&quot;} 5
http_request_duration_seconds_bucket{code=&quot;200&quot;,handler=&quot;found&quot;,method=&quot;get&quot;,le=&quot;10&quot;} 5
http_request_duration_seconds_bucket{code=&quot;200&quot;,handler=&quot;found&quot;,method=&quot;get&quot;,le=&quot;+Inf&quot;} 5
http_request_duration_seconds_sum{code=&quot;200&quot;,handler=&quot;found&quot;,method=&quot;get&quot;} 0.00047495999999999997
http_request_duration_seconds_count{code=&quot;200&quot;,handler=&quot;found&quot;,method=&quot;get&quot;} 5
# HELP http_requests_total Count of all HTTP requests
# TYPE http_requests_total counter
http_requests_total{code=&quot;200&quot;,method=&quot;get&quot;} 5
# HELP version Version information about this binary
# TYPE version gauge
version{version=&quot;v0.3.0&quot;} 1
</code></pre></div>

<h2 id="2-migrate-from-prometheus-operator-to-google-managed-prometheus-with-self-deployed-collection">2 Migrate from Prometheus Operator to Google Managed Prometheus with self-deployed collection<a class="headerlink" href="#2-migrate-from-prometheus-operator-to-google-managed-prometheus-with-self-deployed-collection" title="Permanent link">&para;</a></h2>
<h3 id="20-prerequisite">2.0 Prerequisite<a class="headerlink" href="#20-prerequisite" title="Permanent link">&para;</a></h3>
<p>Verify SA account has correct permissions:</p>
<p><strong>Option 1:</strong> Using GKE with <code>default</code> Compute Service Account, should have all requires permissions as it is using Editor role (roles/editor) on the project. (without WI enabled)</p>
<p><strong>Option 2:</strong> Using GKE with custom Service Account for Nodes (without WI enabled)</p>
<p>Make sure default compute <code>SA</code> has <code>monitoring.metricWriter</code> and <code>monitoring.viewer</code> roles:</p>
<p>gcloud projects add-iam-policy-binding $PROJECT_ID \
 --member='serviceAccount:$PROJECT_NUMBER-compute@developer.gserviceaccount.com' \
 --role=roles/monitoring.metricWriter</p>
<p>gcloud projects add-iam-policy-binding $PROJECT_ID \
 --member='serviceAccount:$PROJECT_NUMBER-compute@developer.gserviceaccount.com' \
 --role=roles/monitoring.viewer</p>
<p>gcloud projects get-iam-policy $PROJECT_ID</p>
<p><strong>Option 3:</strong> Using GKE with WI</p>
<p>Follow the <a href="https://cloud.google.com/stackdriver/docs/managed-prometheus/setup-unmanaged#gmp-wli-svcacct">Configure a service account for Workload Identity</a> instructions</p>
<p><strong>Option 4:</strong> Non-GKE Kubernetes clusters</p>
<p>Follow the <a href="https://cloud.google.com/stackdriver/docs/managed-prometheus/setup-unmanaged#explicit-credentials">Provide credentials explicitly</a> instructions</p>
<h3 id="21-setup-gmp-collection">2.1 Setup GMP Collection<a class="headerlink" href="#21-setup-gmp-collection" title="Permanent link">&para;</a></h3>
<p>While Prometheus Operator, provides us great APIs to declaratively configure Prometheus tasks such as scrape metrics and configure alerts and etc.  Prometheus Operator itself doesn't solve problem of central monitoring system as it's deployed per K8s Cluster or per-namespace, and usually Organizations have many  K8s Clusters and they looking for a central pain of glass view.
Another challenge that Prometheus Operator  doesn't solve is long term storage.</p>
<p>To address above challenges we can use GMP with self-deployed collection. This way once can still use existing <code>Prometheus Operator</code> configuration using CRDs and Declarative APIs and take advantage of Google Managed Prometheus Datastore - based on - Monarch, that can handle incredible scale and store 2 years of metrics at no cost.</p>
<p>See Reference doc - <a href="https://cloud.google.com/stackdriver/docs/managed-prometheus/setup-unmanaged">Get started with self-deployed collection</a></p>
<p><strong>Step 1</strong>  Create <code>prometheus-stack</code> Helm env var file, that will update from prometheus operator binary to GMP binary:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt; EOF&gt;&gt; update_to_gmp.yaml
prometheus:
  prometheusSpec:
    image:
      repository: gke.gcr.io/prometheus-engine/prometheus
      tag: v2.35.0-gmp.2-gke.0
grafana:
  adminPassword: admin
  ingress:
    enabled: true
    path: /*
    pathType: ImplementationSpecific
  service:
    type: NodePort
EOF
</code></pre></div>

<p><strong>Step 1</strong>  Update <code>prometheus-stack</code> Helm chart with GMP binary (image):</p>
<div class="codehilite"><pre><span></span><code>kubectl get -A prometheuses.monitoring.coreos.com
</code></pre></div>

<p><strong>Output:</strong> </p>
<div class="codehilite"><pre><span></span><code>          image: &quot;quay.io/prometheus-operator/prometheus-operator:v0.56.3&quot;
</code></pre></div>

<p><strong>Step 2</strong> Let's replace the <code>prometheus-operator</code> image with <code>gmp</code> image with Helm:</p>
<div class="codehilite"><pre><span></span><code>helm upgrade prometheus-stack prometheus-community/kube-prometheus-stack --version 35.6.0 --values update_to_gmp.yaml
</code></pre></div>

<p><strong>Step 3</strong> Verify that Prometheus Operator is configured with GMP binary:</p>
<div class="codehilite"><pre><span></span><code>kubectl get -A prometheuses.monitoring.coreos.com
</code></pre></div>

<p><strong>Output:</strong> </p>
<div class="codehilite"><pre><span></span><code>monitoring   prometheus-stack-kube-prom-prometheus   v2.35.0-gmp.2-gke.0   1      50m
</code></pre></div>

<h3 id="22-verify-gmp-collection">2.2 Verify GMP Collection<a class="headerlink" href="#22-verify-gmp-collection" title="Permanent link">&para;</a></h3>
<p>See Reference doc - <a href="https://cloud.google.com/stackdriver/docs/managed-prometheus/query#promui-deploy">Managed Service for Prometheus page</a></p>
<p><strong>Step 1</strong> Verify that Prometheus data is being exported and stored at Managed Service for Prometheus Datastore:</p>
<p>The simplest way to verify that your Prometheus data is being exported is to use the PromQL-based Managed Service for Prometheus page in the Google Cloud console.</p>
<p>To view this page, do the following:</p>
<ol>
<li>
<p>In the Google Cloud console, go to Monitoring or use the following button:</p>
</li>
<li>
<p>In the Monitoring navigation pane, click Managed Prometheus.</p>
</li>
</ol>
<p>On the Managed Service for Prometheus page, you can use PromQL queries to retrieve and chart data collected with the managed service. This page can query only data collected by Managed Service for Prometheus.</p>
<p>The following screenshot shows a chart that displays the <code>up</code> metric</p>
<p>To deploy the Prometheus UI for Managed Service for Prometheus, run the following commands:</p>
<p>Deploy the frontend service and configure it to query the scoping project of your metrics scope of your choice:</p>
<h3 id="23-setup-prometheus-ui-for-gmp">2.3 Setup Prometheus UI for GMP<a class="headerlink" href="#23-setup-prometheus-ui-for-gmp" title="Permanent link">&para;</a></h3>
<p>To deploy the Prometheus UI for Managed Service for Prometheus, run the following commands.</p>
<p><strong>Step 1</strong>  Deploy the <code>Prometheus UI</code> frontend service inside of namespace where Grafana setup is running. </p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to continue using a <code>Grafana</code> deployment installed by kube-prometheus, then deploy the Prometheus UI in the <code>monitoring</code> namespace instead. However for production use cases Grafana typically deployed with <code>Grafana</code> Helm Chart or <code>Grafana</code> Operator Chart, allowing operators deploy their customer Dashboards.</p>
</div>
<div class="codehilite"><pre><span></span><code>export GRAFANA_NAMESPACE=monitoring
</code></pre></div>

<div class="codehilite"><pre><span></span><code>curl https://raw.githubusercontent.com/GoogleCloudPlatform/prometheus-engine/v0.4.1/examples/frontend.yaml |
sed &#39;s/\$PROJECT_ID/gcp-demos-331123/&#39; |
kubectl apply -n $GRAFANA_NAMESPACE -f -
</code></pre></div>

<p><strong>Step 2</strong>  Port-forward the <code>frontend</code> service to your local machine. The following example forwards the service to port 9090:</p>
<div class="codehilite"><pre><span></span><code>kubectl -n $GRAFANA_NAMESPACE port-forward svc/frontend 8080:9090
</code></pre></div>

<h3 id="24-setup-grafana-for-gmp">2.4 Setup Grafana for GMP<a class="headerlink" href="#24-setup-grafana-for-gmp" title="Permanent link">&para;</a></h3>
<p>Google Cloud APIs all require authentication using OAuth2; however, Grafana doesn't support OAuth2 authentication for Prometheus data sources. To use Grafana with Managed Service for Prometheus, we've deployed Prometheus UI as an authentication proxy in a previous step.</p>
<p><strong>Option 1:</strong> Configure existing Grafana Dashboard to use GMP</p>
<p>If you would like to take advantage of you existing Dashboards and already deployed Grafana,
the only steps needed is to create a <code>Data Source</code> for Google Managed Prometheus described in this <a href="https://cloud.google.com/stackdriver/docs/managed-prometheus/query#ui-grafana">reference</a></p>
<p>Once configured you can redirect existing dashboards to the new <code>Data Source</code>, or create the new once.</p>
<p><strong>Option 2:</strong> Configure Grafana Dashboard that comes with GMP </p>
<p>Configure Grafana Dashboard that comes with GMP, following this <a href="https://cloud.google.com/stackdriver/docs/managed-prometheus/query#grafana-deploy">steps</a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This option is good only for quick testing Grafana</p>
</div>
<p><strong>Option 3:</strong> Use Grafana Helm Charts or Grafana Operator</p>
<p>For production deployment it is preferred to use  <a href="https://artifacthub.io/packages/helm/grafana/grafana">Grafana Helm Chart</a> or <a href="https://artifacthub.io/packages/olm/community-operators/grafana-operator">Grafana Operator</a> as you can define and recreate you dashboards via json or CRDs in consistent manner.</p>
<h3 id="25-verify-gmp-cost">2.5 Verify GMP Cost<a class="headerlink" href="#25-verify-gmp-cost" title="Permanent link">&para;</a></h3>
<p><strong>Option 1</strong> Estimate Cost based on ingested metrics.</p>
<p><em>Step 1</em> Create a new Grafana Dashboard:</p>
<div class="codehilite"><pre><span></span><code>Data Source: Managed Service for Prometheus

Metric Browser: `rate(gcm_export_samples_exported_total{job=~&quot;.+&quot;,instance=~&quot;.+&quot;}[5m])`

Step: 10
</code></pre></div>

<p><img alt="alt text" src="../images/gmp_cost_calculation.png" /></p>
<p>Example calculation:</p>
<p>N1. 770 Samples per second based on Dashboard value</p>
<p>N2. 770 samples per second * 2628000 seconds/mo = 2023 B samples/mo</p>
<p>N3. Since $0.15/million samples: first 0-50 billion samples#  <a href="https://cloud.google.com/stackdriver/pricing#monitoring-costs">Reference N1</a>  </p>
<p>N4. We can calculate final cost: 2023 B samples/mo * 0.15 = ~303$ per month </p>
<p><strong>Option 2</strong> View your Google Cloud bill</p>
<ol>
<li>
<p>In the Google Cloud console, go to the Billing page.</p>
</li>
<li>
<p>If you have more than one billing account, select Go to linked billing account to view the current project's billing account. To locate a different billing account, select Manage billing accounts and choose the account for which you'd like to get usage reports.</p>
</li>
<li>
<p>Select Reports.</p>
</li>
<li>
<p>From the Services menu, select the Stackdriver Monitoring option.</p>
</li>
<li>
<p>From the SKUs menu, select the following options:</p>
</li>
<li>
<p>Prometheus Samples Ingested</p>
</li>
<li>Monitoring API Requests</li>
</ol>
<h2 id="7-cleanup">7 Cleanup<a class="headerlink" href="#7-cleanup" title="Permanent link">&para;</a></h2>
<p>Delete Kubernetes cluster as it will enquire cost both for GKE and GMP.</p>
<p>Uninstall Helm Charts:</p>
<div class="codehilite"><pre><span></span><code>helm uninstall prometheus-stack -n monitoring
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl delete crd alertmanagerconfigs.monitoring.coreos.com
kubectl delete crd alertmanagers.monitoring.coreos.com
kubectl delete crd podmonitors.monitoring.coreos.com
kubectl delete crd probes.monitoring.coreos.com
kubectl delete crd prometheuses.monitoring.coreos.com
kubectl delete crd prometheusrules.monitoring.coreos.com
kubectl delete crd servicemonitors.monitoring.coreos.com
kubectl delete crd thanosrulers.monitoring.coreos.com
</code></pre></div>

<p>Delete GKE cluster:</p>
<div class="codehilite"><pre><span></span><code>gcloud container clusters delete k8s-prometheus-labs --region us-central1
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href=".." class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Home
            </div>
          </div>
        </a>
      
      
        <a href="../gmp-with-gkestandard-custom/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              GMP scraping Custom App metrics
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://twitter.com/googlecloud" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.4ea5477f.min.js"></script>
      
    
  </body>
</html>